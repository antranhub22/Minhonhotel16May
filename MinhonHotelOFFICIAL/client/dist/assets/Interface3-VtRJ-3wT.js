import{l as Z,r as k,j as e,o as m}from"./index-Bmwy3-fU.js";const B="/assets/hotel-exterior-BsmmGNZ1.jpeg",G={roomNumber:/(?:room(?:\s+number)?|room|phòng)(?:\s*[:#\-]?\s*)([0-9]{1,4}[A-Za-z]?)|(?:staying in|in room|in phòng|phòng số)(?:\s+)([0-9]{1,4}[A-Za-z]?)/i};function A(j){const s=j.match(G.roomNumber);if(s)return s[1]||s[2]||null;const h=j.match(/(?:room details|room number|phòng số)(?:\s*[:#\-]?\s*)([0-9]{1,4}[A-Za-z]?)/i);if(h&&h[1])return h[1];const p=j.match(/(?:details[\s\S]*?room(?:\s+number)?[\s\S]*?)([0-9]{1,4}[A-Za-z]?)/i);return p&&p[1]?p[1]:null}const J=({isActive:j})=>{const{orderSummary:s,setOrderSummary:h,setCurrentInterface:p,setOrder:_,callSummary:n,setCallSummary:D,serviceRequests:N,callDuration:C,callDetails:R,emailSentForCurrentSession:P,setEmailSentForCurrentSession:O,addActiveOrder:F,translateToVietnamese:M,language:l}=Z(),[U,L]=k.useState({}),[T,$]=k.useState(""),q=(i,t)=>{s&&h({...s,[i]:t})};k.useEffect(()=>{if(N&&N.length>0){const i=N.reduce((t,r)=>{const o=r.serviceType;return t[o]||(t[o]=[]),t[o].push(r),t},{});if(L(i),s&&(!s.items||s.items.length===0)){const t=N.map((r,o)=>{let d=1;const b=r.details||{},g=r.requestText.match(/(\d+)\s+(towels|bottles|pieces|cups|glasses|plates|servings|items)/i);g?d=parseInt(g[1]):typeof b.people=="number"&&(d=b.people);let u=10;return r.serviceType==="room-service"?u=15:r.serviceType==="housekeeping"?u=8:r.serviceType==="transportation"?u=25:r.serviceType==="tours-activities"?u=35:r.serviceType==="spa"&&(u=30),{id:`item-${o}`,name:r.serviceType,description:r.requestText,quantity:d,price:u}});h({...s,items:t,totalAmount:t.reduce((r,o)=>r+o.price*o.quantity,0)})}}},[N,s,h]),k.useEffect(()=>{if(j&&n&&s){const i=n.content,t=A(i);if(t&&t!==s.roomNumber&&h({...s,roomNumber:t}),!N||N.length===0){const r=i.match(/List of Requests:([\s\S]*?)(?:\n\nSpecial Instructions|\n\nThe conversation)/);if(r){const o=r[1],d=/Request (\d+): ([^\n]+)/g;let b;const g=[];let u=1;for(;(b=d.exec(o))!==null;){const S=b[2].trim(),f=b.index,c=o.indexOf(`Request ${parseInt(b[1])+1}:`,f),w=c>-1?o.substring(f,c):o.substring(f),x=/- ([^:]+): ([^\n]+)/g;let v;const a={};for(;(v=x.exec(w))!==null;){const z=v[1].trim(),V=v[2].trim();a[z.toLowerCase()]=V}let y="";a["service description"]&&(y+=`${a["service description"]}`),a.details&&(y+=y?`. ${a.details}`:a.details),a.items&&(y+=y?`
Items: ${a.items}`:`Items: ${a.items}`),a["service timing requested"]&&(y+=`
Timing: ${a["service timing requested"]}`),a.destinations&&(y+=`
Destinations: ${a.destinations}`),y||(y=`Requested ${S} service`),g.push({id:u.toString(),name:S,description:y,quantity:1,price:10}),u++}if(g.length>0&&(!s.items||s.items.length===0)){const S=g.map(v=>v.name.toLowerCase().replace(/\s+/g,"-")).join(","),f=A(i)||s.roomNumber,c=i.match(/Service Timing Requested:?\s*([^\n]+)/i),w=c?c[1]:s.deliveryTime;let x=s.deliveryTime;w&&(/soon|immediate|urgent|right now/i.test(w)?x="asap":/30 minute|half hour/i.test(w)?x="30min":/hour|60 minute/i.test(w)?x="1hour":/schedule|later|specific/i.test(w)&&(x="specific")),h({...s,items:g,orderType:S,roomNumber:f,deliveryTime:x,totalAmount:g.reduce((v,a)=>v+a.price*a.quantity,0)})}}}}},[j,n,s,h]);const E=async()=>{var o;if(!s)return;const i=`#ORD-${Math.floor(1e4+Math.random()*9e4)}`;let t;switch(s.deliveryTime){case"asap":t="As soon as possible";break;case"30min":t="30 minutes";break;case"1hour":t="1 hour";break;default:t=s.deliveryTime||"15-20 minutes"}if(_({reference:i,estimatedTime:t,summary:s}),F({reference:i,requestedAt:new Date,estimatedTime:t,status:"Đã ghi nhận"}),P){console.log("Email already sent for this session. Skipping duplicate email sending."),p("interface4");return}if(((o=document.querySelector('[data-interface="interface3vi"]'))==null?void 0:o.getAttribute("data-active"))==="true")console.log("Vietnamese interface is active, skipping email send from English interface");else try{console.log("Sending email with call summary and service requests...");let d=(n==null?void 0:n.content)||"";try{d=await M(d)}catch(c){console.error("Failed to translate summary for email:",c)}console.log("Translated summary for email (Vietnamese):",d);const b=C?`${Math.floor(C/60)}:${(C%60).toString().padStart(2,"0")}`:"0:00";console.log("Call duration for email:",b);const g=`call-${Date.now()}`,u=(R==null?void 0:R.id)||g;console.log("Using callId for email:",u),console.log("Call summary content:",(n==null?void 0:n.content)||"No summary available"),console.log("Preparing email request payload...");const S={toEmail:"tuans2@gmail.com",callDetails:{callId:u,roomNumber:s.roomNumber||"unknown",summary:d||"No summary available",timestamp:(n==null?void 0:n.timestamp)||new Date,duration:b,serviceRequests:s.items.map(c=>c.name),orderReference:i,note:T}};console.log("Email payload prepared:",JSON.stringify(S));const f=/iPhone|iPad|iPod|Android|Mobile|webOS|BlackBerry/i.test(navigator.userAgent);console.log("Device type detected:",f?"MOBILE":"DESKTOP"),setTimeout(async()=>{try{const c=f?"/api/mobile-call-summary-email":"/api/send-call-summary-email";console.log(`Using ${f?"mobile":"standard"} endpoint for email: ${c}`);const w=f?`${c}?_=${Date.now()}`:c;console.log("Sending email request to server...");const x=await fetch(w,{method:"POST",headers:{"Content-Type":"application/json","Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0","X-Device-Type":f?"mobile":"desktop"},body:JSON.stringify(S),cache:"no-cache",credentials:"same-origin"});if(!x.ok)throw new Error(`Server responded with status: ${x.status}`);const v=await x.json();console.log("Email sent with order confirmation:",v),O(!0)}catch(c){console.error("Failed to send email in timeout:",c)}},f?50:500)}catch(d){console.error("Failed to send email:",d)}p("interface4")},I=()=>{!T.trim()||!n||D({...n,content:`${n.content}

Additional Notes:
${T}`})};return s?e.jsx("div",{className:`absolute w-full min-h-screen h-full transition-opacity duration-500 ${j?"opacity-100":"opacity-0 pointer-events-none"} z-30 overflow-y-auto`,id:"interface3",style:{backgroundImage:`linear-gradient(rgba(85,154,154,0.7), rgba(121, 219, 220, 0.6)), url(${B.replace(/\.(jpe?g)$/i,".webp")})`,backgroundSize:"cover",backgroundPosition:"center",fontFamily:"SF Pro Text, Roboto, Open Sans, Arial, sans-serif"},children:e.jsx("div",{className:"container mx-auto flex flex-col p-2 sm:p-4 md:p-8",children:e.jsxs("div",{className:"mx-auto w-full max-w-4xl bg-white/90 rounded-2xl shadow-xl p-3 sm:p-6 md:p-10 mb-4 sm:mb-6 flex-grow border border-white/40 backdrop-blur-md",style:{minHeight:420},children:[e.jsx("div",{className:"mb-3 sm:mb-4 pb-2 sm:pb-3 border-b border-gray-200",children:e.jsx("p",{className:"font-poppins font-bold text-xl sm:text-2xl text-blue-900 tracking-wide",children:m("order_summary",l)})}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 sm:gap-10 md:gap-16",children:[e.jsxs("div",{className:"md:w-3/4 w-full space-y-3 sm:space-y-4",children:[e.jsxs("div",{className:"flex sm:hidden flex-row w-full gap-2 mb-2",children:[e.jsxs("button",{className:"flex-1 flex items-center justify-center px-2 py-1.5 bg-white/80 hover:bg-blue-100 text-blue-900 rounded-full text-xs font-semibold border border-white/30 shadow transition-colors",onClick:()=>p("interface1"),children:[e.jsx("span",{className:"material-icons text-base mr-1",children:"cancel"}),m("cancel",l)]}),e.jsxs("button",{onClick:E,className:"flex-1 bg-[#d4af37] hover:bg-[#ffd700] text-blue-900 font-bold py-1.5 px-3 rounded-full shadow-lg flex items-center justify-center space-x-2 transition-colors border border-white/30 text-xs",style:{letterSpacing:.5},children:[e.jsx("span",{className:"material-icons",children:"send"}),e.jsx("span",{className:"whitespace-nowrap",children:m("send_to_reception",l)})]})]}),e.jsxs("div",{className:"flex flex-col gap-2 mb-2 sm:hidden",children:[e.jsxs("div",{className:"flex flex-row w-full gap-2",children:[e.jsx("button",{className:"h-10 px-3 bg-[#ffe082] hover:bg-[#ffe9b3] text-blue-900 rounded-full text-xs font-semibold shadow transition-colors flex-1",onClick:I,disabled:!T.trim(),children:m("add_note",l)}),e.jsxs("div",{className:"flex items-center space-x-2 w-full justify-center",children:[e.jsx("label",{className:"text-xs text-gray-600 font-medium",children:m("room_number",l)}),e.jsx("input",{type:"text",placeholder:m("enter_room_number",l),className:"w-16 p-2 border border-white/30 rounded-xl focus:ring-2 focus:ring-[#d4af37] focus:border-[#d4af37] bg-white/70 text-gray-900 font-semibold text-xs",value:s.roomNumber,onChange:i=>q("roomNumber",i.target.value)})]}),e.jsx("button",{className:"h-10 px-3 bg-white/70 text-blue-900 rounded-full text-xs font-semibold border border-white/30 shadow flex items-center justify-center",onClick:()=>p("interface3vi"),children:e.jsx("span",{className:"material-icons text-base",children:"language"})})]}),e.jsx("textarea",{placeholder:m("enter_notes",l),className:"w-full p-2 border border-white/30 rounded-xl text-xs bg-white/60 focus:bg-white/90 focus:ring-2 focus:ring-[#d4af37] transition italic font-light text-gray-500",value:T,onChange:i=>$(i.target.value),rows:3,style:{fontFamily:"inherit"}})]}),n&&e.jsxs("div",{id:"summary-container",className:"mb-3 sm:mb-4",children:[e.jsxs("div",{className:"p-3 sm:p-5 bg-white/80 rounded-xl shadow border border-white/30 mb-3 sm:mb-4 relative",style:{backdropFilter:"blur(2px)"},children:[e.jsx("h3",{className:"font-semibold text-base sm:text-lg mb-1 sm:mb-2 text-blue-800",children:m("summary",l)}),e.jsx("div",{className:"text-sm sm:text-base leading-relaxed text-gray-800 whitespace-pre-line",style:{fontWeight:400},children:(n.content||"").split(`
`).filter(t=>!/^Next Step:/i.test(t)&&!/Please Press Send To Reception/i.test(t)).map((t,r)=>{if(/^Guest's Name/i.test(t)){const o=t.replace(/\s*\(used for Guest with a confirmed reservation\)/i,"");return e.jsx("div",{children:e.jsx("b",{children:o})},r)}return/^Room Number:/i.test(t)?e.jsx("div",{children:e.jsx("b",{children:t})},r):/^REQUEST \d+:/i.test(t)?e.jsx("div",{className:"mt-3 mb-1",children:e.jsx("b",{children:t})},r):/^• Service Timing:/i.test(t)?e.jsx("div",{style:{marginLeft:16},children:e.jsx("b",{children:t})},r):/^• Order Details:/i.test(t)?e.jsx("div",{style:{marginLeft:16},children:e.jsx("b",{children:t})},r):/^• Special Requirements:/i.test(t)?e.jsx("div",{style:{marginLeft:16},children:e.jsx("b",{children:t})},r):/^• [^-].+/.test(t)?e.jsx("div",{style:{marginLeft:32},children:t},r):/^\s*[-•]/.test(t)?e.jsx("div",{style:{marginLeft:32},children:t},r):/^\s*$/.test(t)?e.jsx("div",{style:{height:8}},r):e.jsx("div",{children:t},r)})}),e.jsx("div",{className:"mt-2 sm:mt-3 flex justify-end",children:e.jsxs("div",{className:"text-xs text-gray-500",children:[m("generated_at",l)," ",new Date(n.timestamp).toLocaleTimeString()]})})]}),e.jsx("div",{className:"text-center mt-2 mb-1",children:e.jsxs("span",{className:"italic text-sm",style:{color:"#2563eb",background:"#e0f2fe",borderRadius:"6px",padding:"4px 12px",display:"inline-block",fontWeight:500},children:["Please Press ",e.jsx("b",{style:{fontWeight:700,color:"#1d4ed8"},children:"Send To Reception"})," To Complete Your Request"]})})]}),e.jsxs("div",{className:"hidden sm:flex flex-row items-center gap-2 h-10",children:[e.jsx("button",{className:"h-10 px-3 sm:px-4 bg-[#ffe082] hover:bg-[#ffe9b3] text-blue-900 rounded-full text-xs sm:text-sm font-semibold shadow transition-colors",onClick:I,disabled:!T.trim(),children:m("add_note",l)}),e.jsxs("div",{className:"flex items-center space-x-2 w-full justify-center",children:[e.jsx("label",{className:"text-xs sm:text-base text-gray-600 font-medium",children:m("room_number",l)}),e.jsx("input",{type:"text",placeholder:m("enter_room_number",l),className:"w-16 sm:w-32 p-2 border border-white/30 rounded-xl focus:ring-2 focus:ring-[#d4af37] focus:border-[#d4af37] bg-white/70 text-gray-900 font-semibold text-xs sm:text-base",value:s.roomNumber,onChange:i=>q("roomNumber",i.target.value)})]}),e.jsx("button",{className:"h-10 px-3 sm:px-4 bg-white/70 text-blue-900 rounded-full text-xs sm:text-sm font-semibold border border-white/30 shadow flex items-center justify-center",onClick:()=>p("interface3vi"),children:e.jsx("span",{className:"material-icons text-base",children:"language"})})]}),e.jsx("textarea",{placeholder:m("enter_notes",l),className:"hidden sm:block w-full p-2 sm:p-3 border border-white/30 rounded-xl mb-3 sm:mb-4 text-xs sm:text-sm bg-white/60 focus:bg-white/90 focus:ring-2 focus:ring-[#d4af37] transition italic font-light text-gray-500",value:T,onChange:i=>$(i.target.value),rows:3,style:{fontFamily:"inherit"}})]}),e.jsx("div",{className:"md:w-1/4 w-full hidden sm:flex md:justify-end justify-center",children:e.jsxs("div",{className:"flex flex-col items-end space-y-2 sm:space-y-3 w-full md:w-auto",children:[e.jsxs("button",{onClick:E,className:"w-full md:w-auto bg-[#d4af37] hover:bg-[#ffd700] text-blue-900 font-bold py-1.5 sm:py-2 px-3 sm:px-4 rounded-full shadow-lg flex items-center justify-center space-x-2 transition-colors border border-white/30 text-xs sm:text-sm",style:{letterSpacing:.5},children:[e.jsx("span",{className:"material-icons",children:"send"}),e.jsx("span",{className:"whitespace-nowrap",children:m("send_to_reception",l)})]}),e.jsxs("button",{className:"w-full md:w-auto flex items-center justify-center px-2 sm:px-3 py-1.5 bg-white/80 hover:bg-blue-100 text-blue-900 rounded-full text-xs font-semibold border border-white/30 shadow transition-colors",onClick:()=>p("interface1"),children:[e.jsx("span",{className:"material-icons text-base mr-1",children:"cancel"}),m("cancel",l)]})]})})]})]})})}):null};export{J as default};
