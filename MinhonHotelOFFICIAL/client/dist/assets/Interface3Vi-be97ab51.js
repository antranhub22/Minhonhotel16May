import{m as R,r as f,j as e}from"./index-f38482de.js";const B=({isActive:m})=>{const{callSummary:n,orderSummary:i,setCurrentInterface:b,setOrderSummary:y,setOrder:C,serviceRequests:l,vietnameseSummary:g,setVietnameseSummary:V,translateToVietnamese:T,emailSentForCurrentSession:k,setEmailSentForCurrentSession:I,callDetails:N,callDuration:v,language:M}=R(),[$,w]=f.useState(!1),D=(r,a)=>{i&&y({...i,[r]:a})},[j,E]=f.useState(null);f.useEffect(()=>{const r=n?new Date(n.timestamp).getTime().toString():null;m&&n&&(!g||j!==r)&&r!==j&&(E(r),(async()=>{try{console.log("Starting translation of summary to Vietnamese"),w(!0),await T(n.content),w(!1)}catch(c){console.error("Error translating summary:",c),w(!1)}})())},[m,n,g,T,j]),f.useEffect(()=>{var r,a;if(m&&l&&l.length>0&&i){const c=l.map((t,d)=>{let F=1,h=10;t.serviceType==="housekeeping"&&(h=5),t.serviceType==="technical-support"&&(h=0),(t.serviceType.includes("food")||t.serviceType==="room-service")&&(h=8),t.serviceType==="wake-up"&&(h=0);let o="";const s=t.details;return s.roomNumber&&s.roomNumber!=="unknown"&&s.roomNumber!=="Not specified"&&(o+=`Số phòng: ${s.roomNumber}
`),s.date&&s.date!=="Not specified"&&(o+=`Ngày: ${s.date}
`),s.time&&s.time!=="Not specified"&&(o+=`Thời gian: ${s.time}
`),s.people&&(o+=`Số người: ${s.people}
`),s.location&&s.location!=="Not specified"&&(o+=`Địa điểm: ${s.location}
`),s.amount&&s.amount!=="Not specified"&&(o+=`Số tiền: ${s.amount}
`),o+=`
Yêu cầu: ${t.requestText}`,s.otherDetails&&s.otherDetails!=="Not specified"&&s.otherDetails!=="None"&&!s.otherDetails.includes("Not specified")&&(o+=`

Thông tin thêm: ${s.otherDetails}`),{id:(d+1).toString(),name:t.requestText.length>60?t.requestText.substring(0,57)+"...":t.requestText,description:o,quantity:F,price:h,serviceType:t.serviceType}}),S=Array.from(new Set(l.map(t=>t.serviceType))).join(",");let u=i.deliveryTime;l.some(t=>t.details&&t.details.time&&typeof t.details.time=="string"&&t.details.time.toLowerCase().includes("immediate"))&&(u="asap");const x=(a=(r=l.find(t=>t.details&&t.details.roomNumber&&t.details.roomNumber!=="unknown"&&t.details.roomNumber!=="Not specified"))==null?void 0:r.details)==null?void 0:a.roomNumber;y({...i,items:c,totalAmount:c.reduce((t,d)=>t+d.price*d.quantity,0),orderType:S,roomNumber:x||i.roomNumber,deliveryTime:u})}},[l,m,i,y]);function O(r){return r.split(`
`).filter(a=>!/^Bước tiếp theo:/i.test(a)&&!/^Next Step:/i.test(a)&&!/Vui lòng nhấn/i.test(a)&&!/Please Press Send To Reception/i.test(a)).map(a=>a.replace(/\(dùng cho khách có đặt chỗ xác nhận\)/i,"").replace(/\(used for Guest with a confirmed reservation\)/i,"").replace(/\(không được chỉ định\)/i,"").replace(/\(not specified\)/i,"")).join(`
`).replace(/\n{3,}/g,`

`)}const P=async()=>{if(!i)return;const r=g||(n?n.content:"Không có tóm tắt"),a=O(r),c=`#ORD-${Math.floor(1e4+Math.random()*9e4)}`;if(C({reference:c,estimatedTime:"15-20 phút",summary:i}),k){console.log("Email đã được gửi cho phiên này. Bỏ qua việc gửi email trùng lặp."),b("interface4");return}try{console.log("Gửi email với tóm tắt cuộc gọi và yêu cầu dịch vụ từ giao diện tiếng Việt...");const p=v?`${Math.floor(v/60)}:${(v%60).toString().padStart(2,"0")}`:"0:00",S=`call-${Date.now()}`,u=(N==null?void 0:N.id)||S;console.log("Sử dụng callId cho email:",u),console.log("Nội dung tóm tắt cuộc gọi:",a),console.log("Chuẩn bị payload email...");const x={toEmail:"tuans2@gmail.com",callDetails:{callId:u,roomNumber:i.roomNumber||"Cần xác nhận",summary:a,timestamp:n?n.timestamp:new Date,duration:p,serviceRequests:i.items.map(t=>t.name),orderReference:c}};console.log("Payload email đã chuẩn bị:",JSON.stringify(x)),setTimeout(async()=>{try{console.log("Gửi yêu cầu email đến máy chủ...");const t=await fetch("/api/send-call-summary-email",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(x),cache:"no-cache",credentials:"same-origin"});if(!t.ok)throw new Error(`Máy chủ phản hồi với trạng thái: ${t.status}`);const d=await t.json();console.log("Email đã được gửi với xác nhận đơn hàng:",d),I(!0)}catch(t){console.error("Không thể gửi email trong timeout:",t)}},500)}catch(p){console.error("Không thể gửi email:",p)}b("interface4")};return i?e.jsx("div",{className:`absolute w-full min-h-screen h-full transition-opacity duration-500 ${m?"opacity-100 active":"opacity-0 pointer-events-none"} z-30 overflow-y-auto`,id:"interface3vi","data-interface":"interface3vi","data-active":m.toString(),style:{backgroundImage:"linear-gradient(rgba(85,154,154,0.7), rgba(121, 219, 220, 0.6))",backgroundSize:"cover",backgroundPosition:"center",fontFamily:"SF Pro Text, Roboto, Open Sans, Arial, sans-serif"},children:e.jsx("div",{className:"container mx-auto h-full flex flex-col p-2 sm:p-4 md:p-8",children:e.jsxs("div",{className:"mx-auto w-full max-w-3xl bg-white/90 rounded-2xl shadow-xl p-3 sm:p-6 md:p-10 mb-4 sm:mb-6 flex-grow border border-white/40 backdrop-blur-md",style:{minHeight:420},children:[e.jsx("div",{className:"mb-3 sm:mb-4 pb-2 sm:pb-3 border-b border-gray-200",children:e.jsx("p",{className:"font-poppins font-bold text-xl sm:text-2xl text-blue-900 tracking-wide",children:"XEM XÉT & XÁC NHẬN"})}),e.jsx("div",{id:"summary-container",className:"mb-3 sm:mb-4",children:n?e.jsxs("div",{className:"p-3 sm:p-5 bg-white/80 rounded-xl shadow border border-white/30 mb-3 sm:mb-4 relative",style:{backdropFilter:"blur(2px)"},children:[e.jsx("h3",{className:"font-semibold text-base sm:text-lg mb-1 sm:mb-2 text-blue-800",children:"Tóm tắt cuộc trò chuyện"}),$?e.jsxs("div",{className:"animate-pulse space-y-2",children:[e.jsx("div",{className:"h-2 bg-blue-100 rounded w-3/4"}),e.jsx("div",{className:"h-2 bg-blue-100 rounded w-full"}),e.jsx("div",{className:"h-2 bg-blue-100 rounded w-5/6"}),e.jsx("div",{className:"h-2 bg-blue-100 rounded w-2/3"}),e.jsx("p",{className:"text-blue-400 text-xs sm:text-sm italic",children:"Đang dịch sang tiếng Việt..."})]}):e.jsx("p",{className:"text-xs sm:text-base leading-relaxed text-gray-800 whitespace-pre-line",style:{fontWeight:400},children:g||n.content}),e.jsx("div",{className:"mt-2 sm:mt-3 flex justify-end",children:e.jsxs("div",{className:"text-xs text-gray-500",children:["Tạo lúc ",new Date(n.timestamp).toLocaleTimeString()]})})]}):e.jsxs("div",{className:"p-3 sm:p-5 bg-gray-50 rounded-xl shadow border border-dashed border-gray-300 mb-3 sm:mb-4",children:[e.jsxs("div",{className:"animate-pulse flex space-x-2 items-center",children:[e.jsx("div",{className:"h-4 w-4 bg-gray-300 rounded-full"}),e.jsx("div",{className:"h-4 bg-gray-300 rounded w-1/4"})]}),e.jsx("h3",{className:"font-semibold text-base sm:text-lg my-2 text-gray-600",children:"Đang tạo bản tóm tắt..."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-2 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-2 bg-gray-200 rounded w-full"}),e.jsx("div",{className:"h-2 bg-gray-200 rounded w-5/6"})]}),e.jsx("p",{className:"text-gray-400 italic mt-3",children:"AI của chúng tôi đang phân tích cuộc trò chuyện và chuẩn bị bản tóm tắt..."})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row items-center gap-3 sm:gap-4 mb-4 sm:mb-6 w-full",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("label",{className:"text-xs sm:text-base text-gray-600 font-medium",children:"Số phòng"}),e.jsx("input",{type:"text",className:"w-20 sm:w-32 p-2 border border-white/30 rounded-xl focus:ring-2 focus:ring-[#d4af37] focus:border-[#d4af37] bg-white/70 text-gray-900 font-semibold",value:i.roomNumber,onChange:r=>D("roomNumber",r.target.value)})]}),e.jsxs("button",{className:"h-full px-3 sm:px-4 bg-white/70 text-blue-900 rounded-full text-xs sm:text-base font-semibold border border-white/30 shadow flex items-center justify-center",onClick:()=>b("interface3"),style:{fontFamily:"inherit",letterSpacing:.2},children:[e.jsx("span",{className:"material-icons text-base mr-2",children:"translate"}),"Tiếng Anh"]}),e.jsxs("button",{id:"confirmOrderButton",className:"h-full px-4 sm:px-8 py-2 sm:py-4 bg-[#d4af37] hover:bg-[#ffd700] text-blue-900 font-bold rounded-full shadow-lg text-base sm:text-xl transition-colors border border-white/30 flex items-center justify-center",onClick:P,style:{fontFamily:"inherit",letterSpacing:.5},children:[e.jsx("span",{className:"material-icons mr-2 text-lg sm:text-2xl",children:"check_circle"}),"Xác nhận"]})]})]})})}):null};export{B as default};
